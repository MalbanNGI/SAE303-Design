<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obesity Globe</title>
    <!-- amCharts Core Library -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <!-- amCharts Map Library -->
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <!-- amCharts Globe Projections -->
    <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <!-- PapaParse Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>

<body>
    <div id="chartdiv" style="width: 100%; height: 500px;"></div>

    <script>
        // Lire le fichier CSV
        Papa.parse('./share-of-adults-defined-as-obese.csv', {
            download: true,
            header: true,
            complete: function (results) {
                const obesityData = {};

                // Parcourir chaque ligne du CSV
                results.data.forEach(row => {
                    const countryName = row.Entity;
                    const iso3Code = row.Code;
                    const obesityPercentage = parseFloat(row["Prevalence of obesity among adults, BMI >= 30 (crude estimate) (%) - Sex: both sexes - Age group: 18+  years"]);
                    const year = parseInt(row.Year); // Convertir l'année en entier

                    // Filtrer les données pour l'année 2016
                    if (!isNaN(obesityPercentage) && year === 2016) {
                        obesityData[iso3Code] = {
                            name: countryName,
                            value: obesityPercentage
                        };
                    }
                });

                if (Object.keys(obesityData).length === 0) {
                    console.error('Aucune donnée trouvée pour l\'année 2016.');
                } else {
                    createGlobe(obesityData);
                }
            },
            error: function (error) {
                console.error('Erreur lors du chargement du fichier CSV :', error);
            }
        });

        // Fonction pour créer le globe interactif
        function createGlobe(obesityData) {
            console.log(obesityData['name'])
            am5.ready(function () {
                var root = am5.Root.new("chartdiv");
                root.setThemes([am5themes_Animated.new(root)]);

                var chart = root.container.children.push(
                    am5map.MapChart.new(root, {
                        projection: am5map.geoOrthographic(),
                        panX: "rotateX",
                        panY: "rotateY",
                        rotationX: 90,
                        rotationY: 0
                    })
                );

                var countrySeries = chart.series.push(
                    am5map.MapPolygonSeries.new(root, {
                        geoJSON: am5geodata_worldLow
                    })
                );

                // Associer les champs pour les données
                countrySeries.set("valueField", "value");
                countrySeries.set("nameField", "name");
                console.log('x', countrySeries.mapPolygons)
                countrySeries.mapPolygons.template.setAll({
                    tooltipText: "{name} est égal à {obesityData['value']} % ",
                    interactive: true
                });

                // Ajouter les données
                countrySeries.data.setAll(
                    Object.entries(obesityData).map(([iso3, data]) => ({
                        id: iso3,
                        name: data.name,
                        value: data.value
                    }))
                );

                // Vérification des données
                console.log("Données ajoutées à la carte :", countrySeries.data.values);

                chart.animate({
                    key: "rotationX",
                    to: 360,
                    duration: 30000,
                    loops: Infinity
                });

                root.appear(1000, 100);
            });
        }
    </script>
</body>

</html>